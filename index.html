<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>海龜華容道｜2×2 / 3×3 / 4×4（步數＋時間＋震動）</title>
<style>
:root { --gap: 3px; }
body{font-family: system-ui, -apple-system, "Segoe UI", Arial; margin:0; background:#0e2a3b; color:#fff}
.wrap{max-width:900px;margin:0 auto;padding:16px}
h1{font-size:20px;margin:0 0 6px}
.subtitle{opacity:.9;margin:6px 0 10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
select,button{background:#1f6f8b;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
select{appearance:none}
button:hover{filter:brightness(1.1)}
.stats{margin-left:auto;display:flex;gap:12px;align-items:center;font-variant-numeric:tabular-nums; flex-wrap:wrap}
.board{width:min(92vw,720px);aspect-ratio:1/1;position:relative;border-radius:14px;background:#102534;
box-shadow:0 12px 36px rgba(0,0,0,.4);margin:10px auto;touch-action:manipulation;user-select:none;overflow:hidden}
.tile{
position:absolute;background-size:cover;background-repeat:no-repeat;background-position:center;
border-radius:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 6px 14px rgba(0,0,0,.35);
transition:transform .12s ease;will-change:transform;
}
.tile::after{content:"";position:absolute;inset:0;border-radius:12px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
.tile.empty{opacity:0;pointer-events:none}
.gridlines{position:absolute;inset:0;border-radius:14px;pointer-events:none}
.win{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:10;padding:12px;}
.win.show{display:grid}
.win .card{background:#fff;color:#123;padding:18px 22px;border-radius:12px;max-width:min(90vw,560px);max-height: calc(100% - 24px); overflow:auto; -webkit-overflow-scrolling:touch;}
.win .card img{max-width:100%;border-radius:8px;margin-bottom:10px;width:100%;height:auto;display:block}
.win .card h2{margin:.2em 0 .4em;font-size:18px}
.win .card p{margin:.3em 0 1em;line-height:1.5}
.small{font-size:12px;opacity:.8}
.sizes{display:flex;gap:6px;flex-wrap:wrap}
.sizes button.active{background:#1aa37a}

/* 手機上保證看得到清除鍵與統計列 */
@media (max-width: 520px){
#clearCurrent{ order: 98; width: 100%; }
.stats{ order: 99; width: 100%; justify-content:flex-start; }
}
</style>
  <!-- ===== 破關拍照模組：貼上即可用 ===== -->
<style>
  .pb-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:9999}
  .pb-wrap{position:absolute;inset:0;margin:auto;background:#0b2230;color:#fff;max-width:min(92vw,880px);border-radius:14px;box-shadow:0 10px 50px rgba(0,0,0,.35);overflow:hidden}
  .pb-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#0f2e40}
  .pb-head b{font-size:18px}
  .pb-close{background:#173d54;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  .pb-body{display:grid;grid-template-columns:1fr 300px;gap:12px; padding:12px}
  .pb-left{display:grid;gap:8px;align-items:center;justify-items:center}
  .pb-cam{background:#000;display:grid;place-items:center;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden}
  .pb-cam video,.pb-cam img{width:100%;height:100%;object-fit:cover}
  .pb-canvas{display:none}
  .pb-right{display:grid;gap:10px}
  .pb-right .row{display:flex;gap:8px;flex-wrap:wrap}
  .pb-right button,.pb-right label{border:0;background:#184a67;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
  .pb-right button[disabled]{opacity:.6;cursor:not-allowed}
  .pb-right input[type="file"]{display:none}
  .pb-txt{background:#0f2e40;border-radius:10px;padding:10px;font-size:14px;line-height:1.45}
  @media (max-width:900px){.pb-body{grid-template-columns:1fr}}
</style>

<div class="pb-backdrop" id="pb">
  <div class="pb-wrap">
    <div class="pb-head">
      <b>海龜華容道｜破關拍照</b>
      <button class="pb-close" onclick="closePhotoBooth()">關閉</button>
    </div>
    <div class="pb-body">
      <div class="pb-left">
        <div class="pb-cam">
          <video id="pbVideo" playsinline autoplay muted></video>
          <img id="pbUploadPreview" alt="" style="display:none"/>
        </div>
        <canvas id="pbCanvas" class="pb-canvas" width="900" height="1200"></canvas>
      </div>
      <div class="pb-right">
        <div class="row">
          <button id="pbUseCamBtn">開啟相機</button>
          <label for="pbFile">從相簿選照片</label>
          <input id="pbFile" type="file" accept="image/*" />
        </div>
        <div class="row">
          <button data-tpl="patrol" class="tplBtn">套用：巡查員</button>
          <button data-tpl="coast" class="tplBtn">套用：海巡</button>
        </div>
        <div class="row">
          <button id="pbSnapBtn" disabled>拍照/合成</button>
          <a id="pbDl" download="海龜華容道_留念.png">
            <button id="pbDlBtn" disabled>下載圖片</button>
          </a>
        </div>
        <div class="pb-txt">
          使用方式：<br>
          1) 開相機或選相簿 → 2) 選模板（巡查員/海巡）→ 3) 按「拍照/合成」→ 4) 下載圖片。<br>
          小技巧：請把臉置中，退一步取 3:4 半身效果最好。
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== 破關時呼叫 ===== */
function openPhotoBooth(){
  const el = document.getElementById('pb');
  el.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closePhotoBooth(){
  stopCam();
  const el = document.getElementById('pb');
  el.style.display = 'none';
  document.body.style.overflow = '';
}

/* ===== 元件與狀態 ===== */
const pb = {
  video: null, canvas: null, ctx: null, stream: null, usingUpload: false,
  tpl: 'patrol', // 預設模板
  W: 900, H: 1200, // 輸出比例 3:4，夠印A4或社群貼文
};

window.addEventListener('DOMContentLoaded', () => {
  pb.video = document.getElementById('pbVideo');
  pb.canvas = document.getElementById('pbCanvas');
  pb.ctx = pb.canvas.getContext('2d', { willReadFrequently: true });

  document.getElementById('pbUseCamBtn').addEventListener('click', useCamera);
  document.getElementById('pbFile').addEventListener('change', handleFile);
  document.getElementById('pbSnapBtn').addEventListener('click', doSnapshot);
  document.querySelectorAll('.tplBtn').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      pb.tpl = e.currentTarget.dataset.tpl;
      // 視覺回饋
      document.querySelectorAll('.tplBtn').forEach(b=>b.style.outline='');
      e.currentTarget.style.outline = '3px solid #39b5ff';
    });
  });
});

/* ===== 相機 / 相簿 ===== */
async function useCamera(){
  try{
    stopCam();
    pb.usingUpload = false;
    hideUploadPreview();
    pb.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user', aspectRatio: 3/4 }});
    pb.video.srcObject = pb.stream;
    document.getElementById('pbSnapBtn').disabled = false;
  }catch(err){
    alert('相機無法使用，請改用「從相簿選照片」。\n' + err.message);
  }
}
function stopCam(){
  if (pb.stream){
    pb.stream.getTracks().forEach(t=>t.stop());
    pb.stream = null;
  }
}
function handleFile(e){
  const file = e.target.files?.[0];
  if(!file) return;
  stopCam();
  pb.usingUpload = true;
  const url = URL.createObjectURL(file);
  const img = document.getElementById('pbUploadPreview');
  img.onload = ()=> URL.revokeObjectURL(url);
  img.src = url;
  img.style.display = 'block';
  pb.video.style.display = 'none';
  document.getElementById('pbSnapBtn').disabled = false;
}
function hideUploadPreview(){
  const img = document.getElementById('pbUploadPreview');
  img.style.display = 'none';
  pb.video.style.display = 'block';
}

/* ===== 主流程：拍照/合成 → 下載 ===== */
function doSnapshot(){
  const ctx = pb.ctx, W = pb.W, H = pb.H;
  ctx.clearRect(0,0,W,H);

  // 先把相機畫面或上傳圖畫上去（滿版裁切）
  if(pb.usingUpload){
    const img = document.getElementById('pbUploadPreview');
    drawCover(ctx, img, W, H);
  }else{
    const v = pb.video;
    drawCover(ctx, v, W, H);
  }

  // 疊上模板
  if(pb.tpl === 'patrol') drawPatrolOverlay(ctx, W, H);
  else drawCoastOverlay(ctx, W, H);

  // 輸出
  const dataURL = pb.canvas.toDataURL('image/png');
  const a = document.getElementById('pbDl');
  a.href = dataURL;
  document.getElementById('pbDlBtn').disabled = false;

  // 讓預覽看得到成果（可視需要顯示 canvas）
  pb.canvas.style.display = 'block';
}

/* ===== 覆蓋繪製：等比置中裁切 ===== */
function drawCover(ctx, src, W, H){
  const iw = src.videoWidth || src.naturalWidth;
  const ih = src.videoHeight || src.naturalHeight;
  if(!iw || !ih){ alert('來源尚未就緒，請再試一次。'); return; }
  const sRatio = Math.max(W/iw, H/ih);
  const dw = iw * sRatio, dh = ih * sRatio;
  const dx = (W - dw)/2, dy = (H - dh)/2;
  ctx.drawImage(src, dx, dy, dw, dh);
}

/* ===== 兩種模板（純 Canvas 矢量，免外部檔）===== */
function drawPatrolOverlay(ctx, W, H){
  // 深色下導角框
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  roundRect(ctx, 24, 24, W-48, H-48, 28); ctx.fill();

  // 上方抬頭條
  ctx.fillStyle = 'rgba(5,25,40,0.85)';
  roundRect(ctx, 24, 24, W-48, 120, {tl:28,tr:28,br:12,bl:12}); ctx.fill();

  // 左上徽章
  ringBadge(ctx, 70, 84, 26, '巡');

  // 文字
  ctx.fillStyle = '#d7f0ff';
  ctx.font = '700 42px system-ui, Noto Sans TC, sans-serif';
  ctx.fillText('巡查員 一日體驗', 112, 102);

  // 下方名牌
  nameplate(ctx, W, H, '巡查員 PATROL');
  // 右下 Logo 條（示意）
  footerBar(ctx, W, H, '海龜華容道｜海洋保育');
  ctx.restore();
}

function drawCoastOverlay(ctx, W, H){
  // 海藍色外框
  ctx.save();
  ctx.strokeStyle = 'rgba(20,150,210,0.9)';
  ctx.lineWidth = 18;
  roundRect(ctx, 20, 20, W-40, H-40, 26); ctx.stroke();

  // 頭盔條
  ctx.fillStyle = 'rgba(0,60,100,0.85)';
  roundRect(ctx, 40, 40, W-80, 120, 20); ctx.fill();

  // 左上徽章（海）
  ringBadge(ctx, 80, 100, 28, '海');

  // 標題
  ctx.fillStyle = '#e9fbff';
  ctx.font = '700 44px system-ui, Noto Sans TC, sans-serif';
  ctx.fillText('海巡 Coast Guard', 130, 108);

  // 下方肩章
  ctx.fillStyle = 'rgba(0,60,100,0.82)';
  roundRect(ctx, 70, H-210, W-140, 120, 18); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = '700 40px system-ui, Noto Sans TC, sans-serif';
  ctx.fillText('守護海洋・全民同行', 110, H-138);

  // 右下 Logo 條
  footerBar(ctx, W, H, '海龜華容道｜一起減塑');
  ctx.restore();
}

/* ===== 小工具：圓角框、徽章、名牌、頁腳 ===== */
function roundRect(ctx, x, y, w, h, r){
  let radii = typeof r === 'number' ? {tl:r,tr:r,br:r,bl:r} : r;
  const {tl=0,tr=0,br=0,bl=0} = radii;
  ctx.beginPath();
  ctx.moveTo(x+tl, y);
  ctx.arcTo(x+w, y, x+w, y+h, tr);
  ctx.arcTo(x+w, y+h, x, y+h, br);
  ctx.arcTo(x, y+h, x, y, bl);
  ctx.arcTo(x, y, x+w, y, tl);
  ctx.closePath();
}

function ringBadge(ctx, cx, cy, r, txt){
  ctx.save();
  // 外圈
  ctx.beginPath(); ctx.arc(cx, cy, r+6, 0, Math.PI*2); ctx.fillStyle='rgba(255,255,255,.88)'; ctx.fill();
  ctx.beginPath(); ctx.arc(cx, cy, r, 0, Math.PI*2); ctx.fillStyle='rgba(20,140,200,.95)'; ctx.fill();

  // 中心字
  ctx.fillStyle='#fff';
  ctx.font = '700 28px system-ui, Noto Sans TC, sans-serif';
  const w = ctx.measureText(txt).width;
  ctx.fillText(txt, cx - w/2, cy + 10);
  ctx.restore();
}

function nameplate(ctx, W, H, text){
  const w = Math.min(W*0.82, 700), h = 110, x = (W - w)/2, y = H - 220;
  ctx.save();
  ctx.shadowColor = 'rgba(0,0,0,.35)'; ctx.shadowBlur = 12; ctx.shadowOffsetY = 4;
  ctx.fillStyle = 'rgba(10,90,130,.88)';
  roundRect(ctx, x, y, w, h, 16); ctx.fill();
  ctx.fillStyle = '#fff';
  ctx.font = '700 40px system-ui, Noto Sans TC, sans-serif';
  const tw = ctx.measureText(text).width;
  ctx.fillText(text, x + (w - tw)/2, y + 70);
  ctx.restore();
}

function footerBar(ctx, W, H, text){
  const h = 66, y = H - 36 - h, x = 36, w = W - 72;
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,.32)';
  roundRect(ctx, x, y, w, h, 14); ctx.fill();
  ctx.fillStyle = '#e0f6ff';
  ctx.font = '600 28px system-ui, Noto Sans TC, sans-serif';
  ctx.fillText(text, x + 18, y + 44);
  ctx.restore();
}

/* ===== 將影片/相片繪到 canvas 前：確保尺寸 ===== */
(function ensureCanvasSize(){
  const c = document.getElementById('pbCanvas');
  c.width = pb.W; c.height = pb.H;
})();
</script>
<!-- ===== 模組結束 ===== -->
</head>
<body>
<div class="wrap">
<h1>海龜華容道</h1>

<div class="subtitle">
選擇海龜種類：
<select id="turtleSelect" aria-label="選擇海龜種類">
<option value="leatherback">革龜</option>
<option value="green">綠蠵龜</option>
<option value="olive">欖蠵龜</option>
<option value="hawksbill">玳瑁</option>
<option value="loggerhead">赤蠵龜</option>
</select>
</div>

<div class="subtitle">點擊或觸控相鄰空格的拼圖塊，使圖片還原。</div>

<div class="toolbar">
<div class="sizes" role="group" aria-label="選擇難度">
<button data-n="2" class="sizeBtn">2×2 簡單</button>
<button data-n="3" class="sizeBtn active">3×3 一般</button>
<button data-n="4" class="sizeBtn">4×4 挑戰</button>
</div>
<button id="shuffle">重新洗牌</button>
<button id="reset">還原</button>
<button id="toggleVibrate">震動：開</button>
<button id="clearCurrent" onclick="clearCurrentRecord()">清除當前紀錄</button>

<div class="stats">
<span>步數：<strong id="moves">0</strong></span>
<span>時間：<strong id="time">00:00.0</strong></span>
<span>|</span>
<span>歷史最佳步數：<strong id="bestMoves">—</strong></span>
<span>歷史最佳時間：<strong id="bestTime">—</strong></span>
<span id="recordFlag" class="small"></span>
</div>
</div>

<div class="board" id="board" aria-label="Sliding puzzle board" aria-live="polite">
<div class="gridlines" id="gridlines" aria-hidden="true"></div>
<div class="win" id="win"><div class="card"><strong>完成！</strong></div></div>
</div>
</div>

<!-- 破關音效 -->
<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
(function(){
/* ====== 物種資料（圖片、解說）====== */
const turtleData = {
leatherback: { img: 'leatherback.jpg', title: '革龜（Dermochelys coriacea）', desc: '世界上最大的海龜，體長常見 1.5–2.0 公尺以上、體重可逾 500–900 公斤。背甲無硬鱗，為革質外皮覆蓋骨板而得名。台灣曾於東部外海、澎湖、東沙海域有紀錄。', infoImg: 'leatherback_info.jpg' },
green: { img: 'green.jpg', title: '綠蠵龜（Chelonia mydas）', desc: '成龜以海草、海藻為主食，體色偏綠。台灣常見於蘭嶼、綠島與墾丁海域，亦有上岸產卵紀錄點。', infoImg: 'green_info.jpg' },
olive: { img: 'olive.jpg', title: '欖蠵龜（Lepidochelys olivacea）', desc: '體型較小，背甲橄欖綠色，常見於熱帶及亞熱帶沿海。台灣海域偶有出現紀錄。', infoImg: 'olive_info.jpg' },
hawksbill: { img: 'hawksbill.jpg', title: '玳瑁（Eretmochelys imbricata）', desc: '背甲鱗片重疊、龜甲邊緣具鋸齒，常活動於珊瑚礁。台灣南部及離島珊瑚礁區較易見。', infoImg: 'hawksbill_info.jpg' },
loggerhead: { img: 'loggerhead.jpg', title: '赤蠵龜（Caretta caretta）', desc: '頭部寬大、背甲紅褐色，偏好硬殼無脊椎動物。台灣周邊海域有洄游與偶見紀錄。', infoImg: 'loggerhead_info.jpg' }
};

/* ====== 狀態變數 ====== */
let N = 3, total = N*N, emptyGoal = total-1;
let currentTurtle = 'leatherback';
let tiles = [];
let moves = 0, timer = null, startTime = null, elapsedMs = 0;

// 記錄是否為「合法新局」
const run = { startedFromShuffle:false, usedRestore:false, seed:0 };

// DOM
const board = document.getElementById('board');
const gridlines = document.getElementById('gridlines');
const movesEl = document.getElementById('moves');
const timeEl = document.getElementById('time');
const winEl = document.getElementById('win');
const selectEl = document.getElementById('turtleSelect');
const winSound = document.getElementById('winSound');
const toggleBtn = document.getElementById('toggleVibrate');
const flagEl = document.getElementById('recordFlag');

// 震動
let vibrateOn = localStorage.getItem('turtle_vibrate') !== 'off';

/* ====== 紀錄（依物種+尺寸）====== */
const LS_KEY = 'turtle_puzzle_records_v2';
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch(e){ return {}; } }
function saveRecords(r){ localStorage.setItem(LS_KEY, JSON.stringify(r)); }
function keyOf(t,n){ return `${t}__${n}`; }
let records = loadRecords();

function updateBestUI(){
const r = records[keyOf(currentTurtle, N)] || {};
document.getElementById('bestMoves').textContent = (r.bestMoves!=null) ? `${r.bestMoves} 步` : '—';
document.getElementById('bestTime').textContent = (r.bestTimeMs!=null) ? formatMs(r.bestTimeMs) : '—';
}

/* ====== 工具 ====== */
const p2xy = p => ({ x:p%N, y:Math.floor(p/N) });
const xy2p = (x,y) => y*N + x;

function formatMs(ms){
const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), ds = Math.floor((ms%1000)/100);
return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ds}`;
}
function preload(src){ const i = new Image(); i.src = src; }
function setBoardAspect(src){
const img = new Image();
img.onload = ()=>{ board.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`; draw(); };
img.src = src;
}

/* ====== Haptics ====== */
function haptic(kind){
if(!vibrateOn || !('vibrate' in navigator)) return;
if(kind==='move') navigator.vibrate(12);
else if(kind==='shuffle') navigator.vibrate([8,30,8]);
else if(kind==='win') navigator.vibrate([25,30,25,30,40]);
}

/* ====== 計時器 ====== */
function startTimer(){
stopTimer(); startTime = Date.now(); elapsedMs = 0;
timeEl.textContent = '00:00.0';
timer = setInterval(()=>{ elapsedMs = Date.now() - startTime; timeEl.textContent = formatMs(elapsedMs); }, 100);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

/* ====== 洗牌（一定可解）====== */
function shuffle(){
tiles = Array.from({length: total}, (_,i)=>i);
const steps = 80 * N * N;
for(let i=0;i<steps;i++){
const e = tiles.indexOf(emptyGoal);
const {x,y} = p2xy(e);
const ops = [];
if(x>0) ops.push(xy2p(x-1,y));
if(x<N-1) ops.push(xy2p(x+1,y));
if(y>0) ops.push(xy2p(x,y-1));
if(y<N-1) ops.push(xy2p(x,y+1));
const s = ops[Math.floor(Math.random()*ops.length)];
[tiles[e], tiles[s]] = [tiles[s], tiles[e]];
}
moves = 0; movesEl.textContent = moves;
startTimer(); winEl.classList.remove('show');
draw();
haptic('shuffle');

// 新局可計入紀錄
run.startedFromShuffle = true;
run.usedRestore = false;
run.seed = Date.now();
if (flagEl) flagEl.textContent = '（本局可計入紀錄）';
}

/* ====== 棋盤格線 ====== */
function updateGridlines(){
if(N===2){
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat';
}else if(N===3){
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 33.333%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 66.666%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 33.333% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 66.666% 0/1px 100% no-repeat';
}else{
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 25%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 75%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 25% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 75% 0/1px 100% no-repeat';
}
}

/* ====== 繪製 ====== */
function draw(){
board.querySelectorAll('.tile').forEach(t=>t.remove());
const bw = board.clientWidth, bh = board.clientHeight;
const cellX = bw/N, cellY = bh/N;

tiles.forEach((val, idx)=>{
const {x,y} = p2xy(idx);
const tile = document.createElement('div');
tile.className = 'tile' + (val===emptyGoal ? ' empty':'');
tile.style.width = `${cellX - 4}px`;
tile.style.height = `${cellY - 4}px`;
tile.style.transform = `translate(${x*cellX + 2}px, ${y*cellY + 2}px)`;
tile.style.backgroundImage = `url('${turtleData[currentTurtle].img}')`;
tile.style.backgroundSize = `${N*100}% ${N*100}%`;
const bx = (100/(N-1)) * p2xy(val).x;
const by = (100/(N-1)) * p2xy(val).y;
tile.style.backgroundPosition = `${bx}% ${by}%`;

tile.addEventListener('click', ()=>move(idx));
tile.addEventListener('touchstart', e=>{ e.preventDefault(); move(idx); }, {passive:false});
board.appendChild(tile);
});
updateGridlines();
}

/* ====== 移動與勝利 ====== */
function move(idx){
const e = tiles.indexOf(emptyGoal);
const a = p2xy(idx), b = p2xy(e);
if(Math.abs(a.x-b.x)+Math.abs(a.y-b.y)===1){
[tiles[e], tiles[idx]] = [tiles[idx], tiles[e]];
moves++; movesEl.textContent = moves;
draw(); haptic('move');
if(tiles.every((v,i)=>v===i)){
stopTimer();
winSound.currentTime = 0; winSound.play().catch(()=>{});
haptic('win');
showWinCardAndRecord();
}
}
}

function showWinCardAndRecord(){
const eligible = run.startedFromShuffle && !run.usedRestore;
let broke = false;

if (eligible) {
const k = `${currentTurtle}__${N}`;
const r = records[k] || {};
if(r.bestMoves==null || moves < r.bestMoves){ r.bestMoves = moves; broke = true; }
if(r.bestTimeMs==null || elapsedMs < r.bestTimeMs){ r.bestTimeMs = elapsedMs; broke = true; }
records[k] = r; saveRecords(records); updateBestUI();
}

const data = turtleData[currentTurtle];
const extra = eligible
? (broke ? '<br><strong>🎉 刷新歷史最佳！</strong>' : '')
: '<br><em style="color:#888">（此局含還原／非新局，不列入最佳紀錄）</em>';

winEl.innerHTML = `
<div class="card" role="dialog" aria-label="完成解說卡">
<img src="${data.infoImg}" alt="${data.title}" onerror="this.src='${data.img}'">
<h2>${data.title}</h2>
<p style="text-align:left">${data.desc}</p>
<p class="small">本局步數：${movesEl.textContent}｜用時：${timeEl.textContent}${extra}</p>
<button onclick="document.getElementById('win').classList.remove('show')">關閉</button>
</div>`;
winEl.classList.add('show');
}

/* ====== 只清除「當前關卡」紀錄 ====== */
function clearCurrentRecord(){
const key = `${currentTurtle}__${N}`;
const store = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
if (store[key]) {
delete store[key];
localStorage.setItem(LS_KEY, JSON.stringify(store));
document.getElementById('bestMoves').textContent = '—';
document.getElementById('bestTime').textContent = '—';
alert(`已清除「${currentTurtle}」${N}×${N} 的最佳紀錄`);
} else {
alert('目前這一關沒有已儲存的最佳紀錄');
}
}
window.clearCurrentRecord = clearCurrentRecord; // 給 HTML onclick 用

/* ====== 尺寸與事件 ====== */
function changeSize(n){
N = n; total = N*N; emptyGoal = total - 1;
document.querySelectorAll('.sizeBtn').forEach(btn=>{
btn.classList.toggle('active', Number(btn.dataset.n)===N);
});
setBoardAspect(turtleData[currentTurtle].img);
shuffle();
updateBestUI();
}

document.getElementById('shuffle').addEventListener('click', shuffle);

document.getElementById('reset').addEventListener('click', ()=>{
tiles = Array.from({length: total}, (_,i)=>i);
moves = 0; movesEl.textContent = moves;
stopTimer(); elapsedMs = 0; timeEl.textContent='00:00.0';
draw();

// 還原 → 不列入紀錄
run.startedFromShuffle = false;
run.usedRestore = true;
if (flagEl) flagEl.textContent = '（本局不計入紀錄）';
});

document.querySelectorAll('.sizeBtn').forEach(btn=>{
btn.addEventListener('click', ()=> changeSize(Number(btn.dataset.n)));
});

selectEl.addEventListener('change', e=>{
currentTurtle = e.target.value;
preload(turtleData[currentTurtle].img);
preload(turtleData[currentTurtle].infoImg);
setBoardAspect(turtleData[currentTurtle].img);
shuffle();
updateBestUI();
});

// 震動開關
toggleBtn.textContent = vibrateOn ? "震動：開" : "震動：關";
toggleBtn.addEventListener('click', ()=>{
vibrateOn = !vibrateOn;
localStorage.setItem('turtle_vibrate', vibrateOn ? 'on' : 'off');
toggleBtn.textContent = vibrateOn ? "震動：開" : "震動：關";
});

window.addEventListener('resize', draw);

/* ====== 初始化 ====== */
Object.values(turtleData).forEach(t => { preload(t.img); preload(t.infoImg); });
setBoardAspect(turtleData[currentTurtle].img);
updateBestUI();
shuffle();
})();
</script>
</body>
</html>


