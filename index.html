<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>æµ·é¾œè¯å®¹é“ï½œæ‹¼åœ–åˆ‡ç‰‡ç‰ˆï¼ˆ2Ã—2 / 4Ã—4ï¼‰</title>
<style>
  :root { --gap: 6px; --tile: 88px; }
  body{margin:0;background:#0e2a3b;color:#fff;font-family:system-ui,-apple-system,"Segoe UI",Arial}
  header{padding:14px 16px;text-align:center}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:10px 0 6px}
  button{
    border:0;border-radius:10px;padding:10px 14px;cursor:pointer;font-weight:600;
    background:#16a085;color:#fff
  }
  button.secondary{background:#34495e}
  button:disabled{opacity:.6;cursor:default}
  .panel{max-width:520px;margin:0 auto 14px;display:grid;gap:8px;padding:0 14px}
  .stats{
    display:grid;gap:6px;background:#113549;border:1px solid #1f5979;border-radius:12px;padding:10px 12px
  }
  .row{display:flex;justify-content:space-between;flex-wrap:wrap;gap:6px}
  .label{opacity:.9}
  .value{font-weight:700}
  .board-wrap{display:flex;justify-content:center;margin:4px 0 24px}
  .grid{
    display:grid;gap:var(--gap);background:#133c52;padding:var(--gap);
    border-radius:12px;border:1px solid #1f5979;touch-action:manipulation;
  }
  .tile{
    position:relative;
    width:var(--tile);height:var(--tile);
    display:flex;align-items:center;justify-content:center;
    background:#1abc9c;color:#fff;border-radius:10px;user-select:none;cursor:pointer;
    transition:transform .08s ease, box-shadow .08s ease;
    box-shadow:0 2px 0 rgba(0,0,0,.3);
    overflow:hidden;
  }
  .tile:active{transform:translateY(1px);box-shadow:0 1px 0 rgba(0,0,0,.3)}
  .tile .num{
    position:absolute;right:6px;bottom:6px;
    font-size:14px;font-weight:900;
    background:rgba(0,0,0,.45);padding:2px 6px;border-radius:6px;
  }
  .hide-numbers .tile .num{ display:none; }
  .empty{background:#0e2a3b;border:2px dashed #1f5979;box-shadow:none;cursor:default}
  footer{opacity:.8;text-align:center;margin:18px 0 40px;font-size:12px}
  @media (max-width:420px){
    :root{ --tile: 72px; --gap: 5px;}
  }
</style>
</head>
<body>
<header>
  <h1>ğŸ¢ æµ·é¾œè¯å®¹é“ï¼ˆåˆ‡ç‰‡æ‹¼åœ–ç‰ˆï¼‰</h1>
  <div class="controls">
    <button id="btn2" onclick="startGame(2)">2Ã—2 ç°¡æ˜“ç‰ˆ</button>
    <button id="btn4" onclick="startGame(4)">4Ã—4 é€²éšç‰ˆ</button>
    <button class="secondary" onclick="reshuffle()">é‡æ’ / æ–°å±€</button>
    <button class="secondary" id="btnToggleNum" onclick="toggleNumbers()">éš±è—ç·¨è™Ÿ</button>
  </div>
</header>

<section class="panel">
  <div class="stats">
    <div class="row"><span class="label">ç›®å‰ç›¤é¢ï¼š</span><span class="value" id="labelSize">4Ã—4</span></div>
    <div class="row"><span class="label">æ­¥æ•¸ï¼š</span><span class="value" id="currMoves">0</span></div>
    <div class="row"><span class="label">æ™‚é–“ï¼š</span><span class="value" id="currTime">00:00.0</span></div>
    <hr style="border:none;border-top:1px solid #1f5979;opacity:.7">
    <div class="row"><span class="label">æ­·å²æœ€ä½³æ­¥æ•¸ï¼š</span><span class="value" id="bestMoves">â€”</span></div>
    <div class="row"><span class="label">æ­·å²æœ€ä½³æ™‚é–“ï¼š</span><span class="value" id="bestTime">â€”</span></div>
  </div>
</section>

<div class="board-wrap">
  <div id="grid" class="grid" aria-label="æ»‘å¡Šæ‹¼åœ–æ£‹ç›¤"></div>
</div>

<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<footer>æç¤ºï¼šå°‡ç¨‹å¼ä¸­çš„ <code>IMG_URL</code> æ”¹æˆä½ çš„æµ·é¾œåœ–ç‰‡è·¯å¾‘ï¼ˆå»ºè­°æ­£æ–¹å½¢åœ–ï¼‰ã€‚è¨˜éŒ„å„²å­˜åœ¨æœ¬æ©Ÿç€è¦½å™¨ï¼ˆä¾å°ºå¯¸ï¼‰ã€‚</footer>

<script>
/* ---------- è¨­å®šï¼šæ›æˆä½ çš„åœ–ç‰‡è·¯å¾‘ ---------- */
const IMG_URL = "your-turtle-image.jpg"; // â†â† æŠŠé€™è£¡æ›æ‰

/* ---------- ç‹€æ…‹è®Šæ•¸ ---------- */
let size = 4;
let tiles = [];            // 1..n^2-1 èˆ‡ null
let moves = 0;
let timerId = null;
let startAt = null;
let elapsedMs = 0;
let showNumbers = true;
const LS_KEY = "turtle_huarongdao_sprite_records_v1";
let records = loadRecords();

function loadRecords(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; }
  catch(e){ return {}; }
}
function saveRecords(){
  localStorage.setItem(LS_KEY, JSON.stringify(records));
}

/* ---------- UI ç¯€é» ---------- */
const gridEl = document.getElementById('grid');
const currMovesEl = document.getElementById('currMoves');
const currTimeEl  = document.getElementById('currTime');
const labelSizeEl = document.getElementById('labelSize');
const bestMovesEl = document.getElementById('bestMoves');
const bestTimeEl  = document.getElementById('bestTime');
const winSound    = document.getElementById('winSound');
const btnToggleNum= document.getElementById('btnToggleNum');

/* ---------- å·¥å…· ---------- */
function formatMs(ms){
  if(ms == null) return "â€”";
  const m = Math.floor(ms/60000);
  const s = Math.floor((ms%60000)/1000);
  const ds= Math.floor((ms%1000)/100);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ds}`;
}
function updateStats(){
  currMovesEl.textContent = moves;
  currTimeEl.textContent  = formatMs(elapsedMs);
  labelSizeEl.textContent = `${size}Ã—${size}`;
  const r = records[size] || {};
  bestMovesEl.textContent = (r.bestMoves != null) ? `${r.bestMoves} æ­¥` : "â€”";
  bestTimeEl.textContent  = (r.bestTimeMs != null) ? formatMs(r.bestTimeMs) : "â€”";
}

/* ---------- è¨ˆæ™‚å™¨ ---------- */
function startTimer(){
  stopTimer();
  startAt = Date.now();
  timerId = setInterval(()=>{
    elapsedMs = Date.now() - startAt;
    currTimeEl.textContent = formatMs(elapsedMs);
  }, 100);
}
function stopTimer(){
  if(timerId){ clearInterval(timerId); timerId = null; }
}

/* ---------- ç›¤é¢ç”Ÿæˆèˆ‡å¯è§£æ€§ ---------- */
function generateSolved(size){
  const arr = [];
  for(let i=1;i<size*size;i++) arr.push(i);
  arr.push(null);
  return arr;
}
function inversions(array){
  const flat = array.filter(x => x !== null);
  let inv = 0;
  for(let i=0;i<flat.length;i++){
    for(let j=i+1;j<flat.length;j++){
      if(flat[i] > flat[j]) inv++;
    }
  }
  return inv;
}
// å¯è§£æ¢ä»¶ï¼ˆ15-puzzle è¦å‰‡ï¼‰
function isSolvable(arr, size){
  const inv = inversions(arr);
  if(size % 2 === 1){
    return inv % 2 === 0;
  }else{
    const emptyIdx = arr.indexOf(null);
    const emptyRowFromTop = Math.floor(emptyIdx / size);
    const emptyRowFromBottom = size - emptyRowFromTop; // 1..size
    return (inv % 2) !== (emptyRowFromBottom % 2);
  }
}
function shuffleSolvable(size){
  const base = generateSolved(size);
  let arr = base.slice();
  do{
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
  } while (!isSolvable(arr, size) || isSolved(arr));
  return arr;
}
function isSolved(arr=tiles){
  for(let i=0;i<size*size-1;i++){
    if(arr[i] !== i+1) return false;
  }
  return arr[arr.length-1] === null;
}

/* ---------- èƒŒæ™¯åˆ‡ç‰‡å®šä½ ---------- */
// å°‡ç¬¬ v å¡Šï¼ˆ1..n^2-1ï¼‰å°æ‡‰åˆ°åŸåœ–ä¸­çš„ (col,row)
function calcBackgroundForValue(v, size, tilePx){
  const col = (v-1) % size;
  const row = Math.floor((v-1) / size);
  const posX = -(col * tilePx);
  const posY = -(row * tilePx);
  return { posX, posY };
}

/* ---------- ç¹ªè£½ ---------- */
function drawGrid(){
  const tilePx = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile')) || 88;
  gridEl.style.gridTemplateColumns = `repeat(${size}, var(--tile))`;
  gridEl.style.gridTemplateRows    = `repeat(${size}, var(--tile))`;
  gridEl.classList.toggle('hide-numbers', !showNumbers);
  gridEl.innerHTML = '';

  tiles.forEach((val, idx)=>{
    const div = document.createElement('div');
    const isEmpty = (val === null);
    div.className = 'tile' + (isEmpty ? ' empty' : '');
    if(!isEmpty){
      // èƒŒæ™¯åœ–åˆ‡ç‰‡
      const { posX, posY } = calcBackgroundForValue(val, size, tilePx);
      div.style.backgroundImage = `url("${IMG_URL}")`;
      div.style.backgroundSize  = `${size*tilePx}px ${size*tilePx}px`;
      div.style.backgroundPosition = `${posX}px ${posY}px`;
      // ç·¨è™Ÿè§’æ¨™ï¼ˆå¯åˆ‡æ›é¡¯ç¤º/éš±è—ï¼‰
      const num = document.createElement('span');
      num.className = 'num';
      num.textContent = val;
      div.appendChild(num);

      div.setAttribute('role','button');
      div.setAttribute('aria-label',`ç§»å‹•ç¬¬ ${val} å¡Š`);
      div.addEventListener('click', ()=>tryMove(idx));
    }else{
      // ç©ºæ ¼ç”¨èƒŒæ™¯é¡è‰²è¡¨ç¤º
      div.setAttribute('aria-label','ç©ºæ ¼');
    }
    gridEl.appendChild(div);
  });
}

/* ---------- ç§»å‹• ---------- */
function tryMove(idx){
  const emptyIdx = tiles.indexOf(null);
  const ex = emptyIdx % size, ey = Math.floor(emptyIdx/size);
  const x  = idx % size,     y  = Math.floor(idx/size);
  if(Math.abs(ex-x)+Math.abs(ey-y) === 1){
    [tiles[emptyIdx], tiles[idx]] = [tiles[idx], tiles[emptyIdx]];
    moves++;
    drawGrid();
    currMovesEl.textContent = moves;
    checkWin();
  }
}

/* ---------- ç ´é—œ ---------- */
function checkWin(){
  if(!isSolved()) return;
  stopTimer();
  winSound.currentTime = 0;
  winSound.play().catch(()=>{});
  const usedMs = elapsedMs;

  const r = records[size] || {};
  let broke = false;
  if(r.bestMoves == null || moves < r.bestMoves){ r.bestMoves = moves; broke = true; }
  if(r.bestTimeMs == null || usedMs < r.bestTimeMs){ r.bestTimeMs = usedMs; broke = true; }
  records[size] = r; saveRecords(); updateStats();

  const msg = [
    `âœ… ç ´é—œæˆåŠŸï¼`,
    `æ­¥æ•¸ï¼š${moves} æ­¥`,
    `æ™‚é–“ï¼š${formatMs(usedMs)}`,
    (broke ? 'ğŸ‰ æ­å–œåˆ·æ–°æ­·å²æœ€ä½³ï¼' : '')
  ].filter(Boolean).join('\n');
  alert(msg);
}

/* ---------- æ§åˆ¶ ---------- */
function startGame(n){
  size = n;
  tiles = shuffleSolvable(size);
  moves = 0;
  elapsedMs = 0;
  updateStats();
  drawGrid();
  startTimer();
  document.getElementById('btn2').disabled = (size===2);
  document.getElementById('btn4').disabled = (size===4);
}
function reshuffle(){
  tiles = shuffleSolvable(size);
  moves = 0;
  elapsedMs = 0;
  updateStats();
  drawGrid();
  startTimer();
}
function toggleNumbers(){
  showNumbers = !showNumbers;
  btnToggleNum.textContent = showNumbers ? 'éš±è—ç·¨è™Ÿ' : 'é¡¯ç¤ºç·¨è™Ÿ';
  drawGrid();
}

/* ---------- éµç›¤æ–¹å‘éµ ---------- */
document.addEventListener('keydown', (e)=>{
  const key = e.key;
  const emptyIdx = tiles.indexOf(null);
  const ex = emptyIdx % size, ey = Math.floor(emptyIdx/size);
  le
