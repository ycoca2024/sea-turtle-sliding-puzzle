<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æµ·é¾œè¯å®¹é“ï½œ2Ã—2 / 3Ã—3 / 4Ã—4ï¼ˆæ­¥æ•¸ï¼‹æ™‚é–“ï¼‹éœ‡å‹•ï¼‰</title>
<style>
:root { --gap: 3px; }
body{font-family: system-ui, -apple-system, "Segoe UI", Arial; margin:0; background:#0e2a3b; color:#fff}
.wrap{max-width:900px;margin:0 auto;padding:16px}
h1{font-size:20px;margin:0 0 6px}
.subtitle{opacity:.9;margin:6px 0 10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
select,button{background:#1f6f8b;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
select{appearance:none}
button:hover{filter:brightness(1.1)}
.stats{margin-left:auto;display:flex;gap:12px;align-items:center;font-variant-numeric:tabular-nums; flex-wrap:wrap}
.board{width:min(92vw,720px);aspect-ratio:1/1;position:relative;border-radius:14px;background:#102534;
box-shadow:0 12px 36px rgba(0,0,0,.4);margin:10px auto;touch-action:manipulation;user-select:none;overflow:hidden}
.tile{
position:absolute;background-size:cover;background-repeat:no-repeat;background-position:center;
border-radius:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 6px 14px rgba(0,0,0,.35);
transition:transform .12s ease;will-change:transform;
}
.tile::after{content:"";position:absolute;inset:0;border-radius:12px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
.tile.empty{opacity:0;pointer-events:none}
.gridlines{position:absolute;inset:0;border-radius:14px;pointer-events:none}
.win{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:10;padding:12px;}
.win.show{display:grid}
.win .card{background:#fff;color:#123;padding:18px 22px;border-radius:12px;max-width:min(90vw,560px);max-height: calc(100% - 24px); overflow:auto; -webkit-overflow-scrolling:touch;}
.win .card img{max-width:100%;border-radius:8px;margin-bottom:10px;width:100%;height:auto;display:block}
.win .card h2{margin:.2em 0 .4em;font-size:18px}
.win .card p{margin:.3em 0 1em;line-height:1.5}
.small{font-size:12px;opacity:.8}
.sizes{display:flex;gap:6px;flex-wrap:wrap}
.sizes button.active{background:#1aa37a}
  @media (max-width: 520px){
  #clearCurrent{ order: 98; width: 100%; }
  .stats{ order: 99; width: 100%; justify-content:flex-start; }
}
</style>
</head>
<body>
<div class="wrap">
<h1>æµ·é¾œè¯å®¹é“</h1>

<div class="subtitle">
é¸æ“‡æµ·é¾œç¨®é¡ï¼š
<select id="turtleSelect" aria-label="é¸æ“‡æµ·é¾œç¨®é¡">
<option value="leatherback">é©é¾œ</option>
<option value="green">ç¶ è µé¾œ</option>
<option value="olive">æ¬–è µé¾œ</option>
<option value="hawksbill">ç³ç‘</option>
<option value="loggerhead">èµ¤è µé¾œ</option>
</select>
</div>

<div class="subtitle">é»æ“Šæˆ–è§¸æ§ç›¸é„°ç©ºæ ¼çš„æ‹¼åœ–å¡Šï¼Œä½¿åœ–ç‰‡é‚„åŸã€‚</div>

<div class="toolbar">
<div class="sizes" role="group" aria-label="é¸æ“‡é›£åº¦">
<button data-n="2" class="sizeBtn">2Ã—2 ç°¡å–®</button>
<button data-n="3" class="sizeBtn active">3Ã—3 ä¸€èˆ¬</button>
<button data-n="4" class="sizeBtn">4Ã—4 æŒ‘æˆ°</button>
</div>
<button id="shuffle">é‡æ–°æ´—ç‰Œ</button>
<button id="reset">é‚„åŸ</button>
<button id="toggleVibrate">éœ‡å‹•ï¼šé–‹</button>
<button id="clearCurrent" onclick="clearCurrentRecord()">æ¸…é™¤ç•¶å‰ç´€éŒ„</button>
<div class="stats">
<span>æ­¥æ•¸ï¼š<strong id="moves">0</strong></span>
<span>æ™‚é–“ï¼š<strong id="time">00:00.0</strong></span>
<span>|</span>
<span>æ­·å²æœ€ä½³æ­¥æ•¸ï¼š<strong id="bestMoves">â€”</strong></span>
<span>æ­·å²æœ€ä½³æ™‚é–“ï¼š<strong id="bestTime">â€”</strong></span>
 <span id="recordFlag" class="small"></span>
</div>
</div>

<div class="board" id="board" aria-label="Sliding puzzle board" aria-live="polite">
<div class="gridlines" id="gridlines" aria-hidden="true"></div>
<div class="win" id="win"><div class="card"><strong>å®Œæˆï¼</strong></div></div>
</div>
</div>

<!-- ç ´é—œéŸ³æ•ˆ -->
<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script>
(function(){
/* ====== ç‰©ç¨®è³‡æ–™ï¼ˆåœ–ç‰‡ã€è§£èªªï¼‰====== */
const turtleData = {
leatherback: { img: 'leatherback.jpg', title: 'é©é¾œï¼ˆDermochelys coriaceaï¼‰', desc: 'ä¸–ç•Œä¸Šæœ€å¤§çš„æµ·é¾œï¼Œé«”é•·å¸¸è¦‹ 1.5â€“2.0 å…¬å°ºä»¥ä¸Šã€é«”é‡å¯é€¾ 500â€“900 å…¬æ–¤ã€‚èƒŒç”²ç„¡ç¡¬é±—ï¼Œç‚ºé©è³ªå¤–çš®è¦†è“‹éª¨æ¿è€Œå¾—åã€‚å°ç£æ›¾æ–¼æ±éƒ¨å¤–æµ·ã€æ¾æ¹–ã€æ±æ²™æµ·åŸŸæœ‰ç´€éŒ„ã€‚', infoImg: 'leatherback_info.jpg' },
green: { img: 'green.jpg', title: 'ç¶ è µé¾œï¼ˆChelonia mydasï¼‰', desc: 'æˆé¾œä»¥æµ·è‰ã€æµ·è—»ç‚ºä¸»é£Ÿï¼Œé«”è‰²åç¶ ã€‚å°ç£å¸¸è¦‹æ–¼è˜­å¶¼ã€ç¶ å³¶èˆ‡å¢¾ä¸æµ·åŸŸï¼Œäº¦æœ‰ä¸Šå²¸ç”¢åµç´€éŒ„é»ã€‚', infoImg: 'green_info.jpg' },
olive: { img: 'olive.jpg', title: 'æ¬–è µé¾œï¼ˆLepidochelys olivaceaï¼‰', desc: 'é«”å‹è¼ƒå°ï¼ŒèƒŒç”²æ©„æ¬–ç¶ è‰²ï¼Œå¸¸è¦‹æ–¼ç†±å¸¶åŠäºç†±å¸¶æ²¿æµ·ã€‚å°ç£æµ·åŸŸå¶æœ‰å‡ºç¾ç´€éŒ„ã€‚', infoImg: 'olive_info.jpg' },
hawksbill: { img: 'hawksbill.jpg', title: 'ç³ç‘ï¼ˆEretmochelys imbricataï¼‰', desc: 'èƒŒç”²é±—ç‰‡é‡ç–Šã€é¾œç”²é‚Šç·£å…·é‹¸é½’ï¼Œå¸¸æ´»å‹•æ–¼çŠç‘šç¤ã€‚å°ç£å—éƒ¨åŠé›¢å³¶çŠç‘šç¤å€è¼ƒæ˜“è¦‹ã€‚', infoImg: 'hawksbill_info.jpg' },
loggerhead: { img: 'loggerhead.jpg', title: 'èµ¤è µé¾œï¼ˆCaretta carettaï¼‰', desc: 'é ­éƒ¨å¯¬å¤§ã€èƒŒç”²ç´…è¤è‰²ï¼Œåå¥½ç¡¬æ®¼ç„¡è„Šæ¤å‹•ç‰©ã€‚å°ç£å‘¨é‚Šæµ·åŸŸæœ‰æ´„æ¸¸èˆ‡å¶è¦‹ç´€éŒ„ã€‚', infoImg: 'loggerhead_info.jpg' }
};

/* ====== ç‹€æ…‹è®Šæ•¸ ====== */
let N = 3; // å°ºå¯¸ï¼š2 / 3 / 4
let total = N * N;
let emptyGoal = total - 1;
let currentTurtle = 'leatherback';
// ç´€éŒ„é€™ä¸€å±€æ˜¯å¦æ˜¯ã€Œåˆæ³•æ–°å±€ã€
let run = {
  startedFromShuffle: false, // åªæœ‰æŒ‰ã€Œé‡æ–°æ´—ç‰Œã€æ‰æœƒè®Šæˆ true
  usedRestore: false,        // åªè¦æŒ‰éã€Œé‚„åŸã€å°±æœƒè®Šæˆ true
  seed: 0
};

// ç”¨ä¾†ç¢ºèªæ‰“äº‚å¾Œçš„ç›¤é¢ï¼ˆå¯ç•™è‘—ä»¥å¾Œè¦åšæ›´åš´æ ¼é©—è­‰ï¼‰
function tilesHash(arr){
  return btoa(arr.map(v => v===emptyGoal ? 'E' : v).join(','));
}
const board = document.getElementById('board');
const gridlines= document.getElementById('gridlines');
const movesEl = document.getElementById('moves');
const timeEl = document.getElementById('time');
const winEl = document.getElementById('win');
const selectEl = document.getElementById('turtleSelect');
const winSound = document.getElementById('winSound');
const toggleBtn= document.getElementById('toggleVibrate');

let vibrateOn = localStorage.getItem('turtle_vibrate') !== 'off'; // âœ… å…ˆå®£å‘Š
let tiles = [];
let moves = 0, timer = null, startTime = null, elapsedMs = 0;
let isNewGame = true;



  // â€¦å…¶é¤˜ç¨‹å¼ï¼ˆäº‹ä»¶ç¶å®šã€shuffleã€draw ç­‰ï¼‰â€¦
})();
function reset() {
  // é‡é–‹ä¸€å±€
  isNewGame = true;
  moves = 0;
  // é‡æ–°æ‰“äº‚æ‹¼åœ–...
  draw();
}
const flagEl = document.getElementById('recordFlag');
flagEl.textContent = (run.startedFromShuffle && !run.usedRestore) ? 'ï¼ˆæœ¬å±€å¯è¨ˆå…¥ç´€éŒ„ï¼‰' : 'ï¼ˆæœ¬å±€ä¸è¨ˆå…¥ç´€éŒ„ï¼‰';
function restore() {
  // é‚„åŸèˆŠç‹€æ…‹ï¼Œä¸ç®—æ–°å±€
  isNewGame = false;
  // ...æŠŠç‹€æ…‹å¾©åŸ
  draw();
}

function checkWin() {
  if (puzzleSolved()) {
    if (isNewGame) {
      // åªæœ‰æ–°å±€é€šé—œæ‰æ›´æ–°æœ€ä½³ç´€éŒ„
      let best = localStorage.getItem('bestSteps');
      if (!best || moves < best) {
        localStorage.setItem('bestSteps', moves);
      }
    }
    alert("æˆåŠŸç ´é—œï¼");
  }
}
/* ====== æ­·å²æœ€ä½³ç´€éŒ„ï¼ˆä¾ã€Œç‰©ç¨® + å°ºå¯¸ã€åˆ†é–‹ï¼‰====== */
const LS_KEY = 'turtle_puzzle_records_v2';
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch(e){ return {}; } }
function saveRecords(){ localStorage.setItem(LS_KEY, JSON.stringify(records)); }
function keyOf(turtle, n){ return `${turtle}__${n}`; }
let records = loadRecords(); // { "leatherback__3": {bestMoves, bestTimeMs}, ... }

function updateBestUI(){
const r = records[keyOf(currentTurtle, N)] || {};
document.getElementById('bestMoves').textContent = (r.bestMoves!=null) ? `${r.bestMoves} æ­¥` : 'â€”';
document.getElementById('bestTime').textContent = (r.bestTimeMs!=null) ? formatMs(r.bestTimeMs) : 'â€”';
}

/* ====== å·¥å…· ====== */
const p2xy = p => ({ x: p % N, y: Math.floor(p / N) });
const xy2p = (x,y) => y * N + x;

function formatMs(ms){
const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), ds= Math.floor((ms%1000)/100);
return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ds}`;
}
function preload(src){ const i = new Image(); i.src = src; }

function setBoardAspect(src){
const img = new Image();
img.onload = () => { board.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`; draw(); };
img.src = src;
}

/* ====== Hapticsï¼ˆéœ‡å‹•ï¼‰====== */
function haptic(kind){
if(!vibrateOn) return;
if(!('vibrate' in navigator)) return; // iOS Safari å¤šåŠä¸æ”¯æ´
if(kind === 'move') navigator.vibrate(12);
else if(kind==='shuffle') navigator.vibrate([8,30,8]);
else if(kind==='win') navigator.vibrate([25,30,25,30,40]);
}

/* ====== è¨ˆæ™‚å™¨ ====== */
function startTimer(){
stopTimer();
startTime = Date.now(); elapsedMs = 0;
timeEl.textContent = '00:00.0';
timer = setInterval(()=>{ elapsedMs = Date.now() - startTime; timeEl.textContent = formatMs(elapsedMs); }, 100);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

/* ====== æ´—ç‰Œï¼ˆåˆæ³•æ­¥é©Ÿæ‰“äº‚ â†’ ä¸€å®šå¯è§£ï¼‰====== */
function shuffle(){
  tiles = Array.from({length: total}, (_,i)=>i);
  const steps = 80 * N * N;
  for(let i=0;i<steps;i++){
    const e = tiles.indexOf(emptyGoal);
    const {x,y} = p2xy(e);
    const ops = [];
    if(x>0)   ops.push(xy2p(x-1,y));
    if(x<N-1) ops.push(xy2p(x+1,y));
    if(y>0)   ops.push(xy2p(x,y-1));
    if(y<N-1) ops.push(xy2p(x,y+1));
    const s = ops[Math.floor(Math.random()*ops.length)];
    [tiles[e], tiles[s]] = [tiles[s], tiles[e]];
  }
  moves = 0; movesEl.textContent = moves;
  startTimer(); winEl.classList.remove('show');
  draw();
  haptic('shuffle');             // â† åˆä½µæˆä¸€è¡Œ

  // â˜… æ´—ç‰Œä»£è¡¨æ–°å±€ï¼Œå¯è¨ˆå…¥ç´€éŒ„
  run.startedFromShuffle = true;
  run.usedRestore = false;
  run.seed = Date.now();

  const flagEl = document.getElementById('recordFlag');
  if (flagEl) flagEl.textContent = 'ï¼ˆæœ¬å±€å¯è¨ˆå…¥ç´€éŒ„ï¼‰';
}
  ('shuffle');
}

/* ====== æ£‹ç›¤æ ¼ç·š ====== */
function updateGridlines(){
if(N===2){
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat';
}else if(N===3){
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 33.333%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 66.666%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 33.333% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 66.666% 0/1px 100% no-repeat';
}else{
gridlines.style.background =
'linear-gradient(#ffffff26,#ffffff26) 0 25%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
'linear-gradient(#ffffff26,#ffffff26) 0 75%/100% 1px no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 25% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat,'+
'linear-gradient(90deg,#ffffff26,#ffffff26) 75% 0/1px 100% no-repeat';
}
}

/* ====== ç¹ªè£½ ====== */
function draw(){
board.querySelectorAll('.tile').forEach(t=>t.remove());

const bw = board.clientWidth, bh = board.clientHeight;
const cellX = bw / N, cellY = bh / N;

tiles.forEach((val, idx)=>{
const {x, y} = p2xy(idx);
const tile = document.createElement('div');
tile.className = 'tile' + (val === emptyGoal ? ' empty' : '');
tile.style.width = `${cellX - 4}px`;
tile.style.height = `${cellY - 4}px`;
tile.style.transform = `translate(${x * cellX + 2}px, ${y * cellY + 2}px)`;
tile.style.backgroundImage = `url('${turtleData[currentTurtle].img}')`;
tile.style.backgroundSize = `${N*100}% ${N*100}%`;
const bx = (100/(N-1)) * p2xy(val).x;
const by = (100/(N-1)) * p2xy(val).y;
tile.style.backgroundPosition = `${bx}% ${by}%`;

tile.addEventListener('click', ()=>move(idx));
tile.addEventListener('touchstart', e=>{ e.preventDefault(); move(idx); }, {passive:false});
board.appendChild(tile);
});

updateGridlines();
}

/* ====== ç§»å‹•èˆ‡å‹åˆ©åˆ¤å®š ====== */
function move(idx){
const e = tiles.indexOf(emptyGoal);
const a = p2xy(idx), b = p2xy(e);
if(Math.abs(a.x-b.x)+Math.abs(a.y-b.y)===1){
[tiles[e], tiles[idx]] = [tiles[idx], tiles[e]];
moves++; movesEl.textContent = moves;
draw(); haptic('move');
if(tiles.every((v,i)=>v===i)){
stopTimer();
winSound.currentTime = 0; winSound.play().catch(()=>{});
haptic('win');
 
  function clearCurrentRecord(){
  const key = `${currentTurtle}__${N}`;
  const store = JSON.parse(localStorage.getItem('turtle_puzzle_records_v2') || '{}');
  if (store[key]) {
    delete store[key];
    localStorage.setItem('turtle_puzzle_records_v2', JSON.stringify(store));
    document.getElementById('bestMoves').textContent = 'â€”';
    document.getElementById('bestTime').textContent  = 'â€”';
    alert(`å·²æ¸…é™¤ã€Œ${currentTurtle}ã€${N}Ã—${N} çš„æœ€ä½³ç´€éŒ„`);
  } else {
    alert('ç›®å‰é€™ä¸€é—œæ²’æœ‰å·²å„²å­˜çš„æœ€ä½³ç´€éŒ„');
  }
}
window.clearCurrentRecord = clearCurrentRecord; // è®“ HTML onclick å¯å‘¼å«
}
}

ffunction showWinCardAndRecord(){
  const eligible = run.startedFromShuffle && !run.usedRestore;
  let broke = false; // â† æ”¾åœ¨å¤–å±¤ï¼Œä¸‹é¢å¯å…±ç”¨

  if (eligible) {
    const k = `${currentTurtle}__${N}`;
    const r = records[k] || {};
    if(r.bestMoves==null || moves < r.bestMoves){ r.bestMoves = moves; broke = true; }
    if(r.bestTimeMs==null || elapsedMs < r.bestTimeMs){ r.bestTimeMs = elapsedMs; broke = true; }
    records[k] = r; saveRecords(); updateBestUI();
  }

  const data = turtleData[currentTurtle];
  const extra = eligible
    ? (broke ? '<br><strong>ğŸ‰ åˆ·æ–°æ­·å²æœ€ä½³ï¼</strong>' : '')
    : '<br><em style="color:#888">ï¼ˆæ­¤å±€å«é‚„åŸï¼éæ–°å±€ï¼Œä¸åˆ—å…¥æœ€ä½³ç´€éŒ„ï¼‰</em>';

  winEl.innerHTML = `
    <div class="card" role="dialog" aria-label="å®Œæˆè§£èªªå¡">
      <img src="${data.infoImg}" alt="${data.title}" onerror="this.src='${data.img}'">
      <h2>${data.title}</h2>
      <p style="text-align:left">${data.desc}</p>
      <p class="small">æœ¬å±€æ­¥æ•¸ï¼š${movesEl.textContent}ï½œç”¨æ™‚ï¼š${timeEl.textContent}${extra}</p>
      <button onclick="document.getElementById('win').classList.remove('show')">é—œé–‰</button>
    </div>`;
  winEl.classList.add('show');
}
/* ====== å°ºå¯¸åˆ‡æ›èˆ‡äº‹ä»¶ ====== */
function changeSize(n){
N = n; total = N*N; emptyGoal = total - 1;
document.querySelectorAll('.sizeBtn').forEach(btn=>{
btn.classList.toggle('active', Number(btn.dataset.n)===N);
});
setBoardAspect(turtleData[currentTurtle].img);
shuffle();
updateBestUI();
}

document.getElementById('shuffle').addEventListener('click', shuffle);
document.getElementById('reset').addEventListener('click', ()=>{
  tiles = Array.from({length: total}, (_,i)=>i);
  moves = 0; movesEl.textContent = moves;
  stopTimer(); elapsedMs = 0; timeEl.textContent='00:00.0';
  draw();

  // â˜… é‚„åŸ â†’ ä¸åˆ—å…¥ç´€éŒ„
  run.startedFromShuffle = false;
  run.usedRestore = true;

  const flagEl = document.getElementById('recordFlag');
  if (flagEl) flagEl.textContent = 'ï¼ˆæœ¬å±€ä¸è¨ˆå…¥ç´€éŒ„ï¼‰';
});
document.querySelectorAll('.sizeBtn').forEach(btn=>{
btn.addEventListener('click', ()=> changeSize(Number(btn.dataset.n)));
});

selectEl.addEventListener('change', e=>{
currentTurtle = e.target.value;
preload(turtleData[currentTurtle].img);
preload(turtleData[currentTurtle].infoImg);
setBoardAspect(turtleData[currentTurtle].img);
shuffle();
updateBestUI();
});

// éœ‡å‹•é–‹é—œæŒ‰éˆ•
toggleBtn.textContent = vibrateOn ? "éœ‡å‹•ï¼šé–‹" : "éœ‡å‹•ï¼šé—œ";
toggleBtn.addEventListener('click', ()=>{
vibrateOn = !vibrateOn;
localStorage.setItem('turtle_vibrate', vibrateOn ? 'on' : 'off');
toggleBtn.textContent = vibrateOn ? "éœ‡å‹•ï¼šé–‹" : "éœ‡å‹•ï¼šé—œ";
});

window.addEventListener('resize', draw);

/* ====== åˆå§‹åŒ– ====== */
Object.values(turtleData).forEach(t => { preload(t.img); preload(t.infoImg); });
setBoardAspect(turtleData[currentTurtle].img);
updateBestUI();
shuffle();
})();
</script>
</body>
</html>

