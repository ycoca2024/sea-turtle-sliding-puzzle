<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æµ·é¾œè¯å®¹é“ï½œ2Ã—2 / 3Ã—3 / 4Ã—4ï¼ˆæ­¥æ•¸ï¼‹æ™‚é–“ï¼‹éœ‡å‹•ï¼‹æ‹ç…§ï¼‰</title>
<style>
:root { --gap: 3px; }
body{font-family: system-ui, -apple-system, "Segoe UI", Arial; margin:0; background:#0e2a3b; color:#fff}
.wrap{max-width:900px;margin:0 auto;padding:16px}
h1{font-size:20px;margin:0 0 6px}
.subtitle{opacity:.9;margin:6px 0 10px}
.toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
select,button{background:#1f6f8b;color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
select{appearance:none}
button:hover{filter:brightness(1.1)}
.stats{margin-left:auto;display:flex;gap:12px;align-items:center;font-variant-numeric:tabular-nums; flex-wrap:wrap}
.board{width:min(92vw,720px);aspect-ratio:1/1;position:relative;border-radius:14px;background:#102534;
box-shadow:0 12px 36px rgba(0,0,0,.4);margin:10px auto;touch-action:manipulation;user-select:none;overflow:hidden}
.tile{
position:absolute;background-size:cover;background-repeat:no-repeat;background-position:center;
border-radius:12px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.06),0 6px 14px rgba(0,0,0,.35);
transition:transform .12s ease;will-change:transform;
}
.tile::after{content:"";position:absolute;inset:0;border-radius:12px;box-shadow:inset 0 0 0 1px rgba(0,0,0,.25)}
.tile.empty{opacity:0;pointer-events:none}
.gridlines{position:absolute;inset:0;border-radius:14px;pointer-events:none}
.win{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.25);backdrop-filter:blur(2px);z-index:10;padding:12px;}
.win.show{display:grid}
.win .card{background:#fff;color:#123;padding:18px 22px;border-radius:12px;max-width:min(90vw,560px);max-height: calc(100% - 24px); overflow:auto; -webkit-overflow-scrolling:touch;}
.win .card img{max-width:100%;border-radius:8px;margin-bottom:10px;width:100%;height:auto;display:block}
.win .card h2{margin:.2em 0 .4em;font-size:18px}
.win .card p{margin:.3em 0 1em;line-height:1.5}
.small{font-size:12px;opacity:.8}
.sizes{display:flex;gap:6px;flex-wrap:wrap}
.sizes button.active{background:#1aa37a}

/* è§£èªªåœ–è¦–çª— */
.exp-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:8888}
.exp-wrap{position:absolute;inset:0;margin:auto;max-width:min(96vw,980px);background:#0b2230;border-radius:14px;overflow:hidden;box-shadow:0 10px 50px rgba(0,0,0,.35)}
.exp-head{display:flex;justify-content:space-between;align-items:center;background:#0f2e40;color:#fff;padding:10px 14px}
.exp-body{padding:10px;background:#0b2230}
.exp-body img{display:block;width:100%;height:auto;border-radius:10px;background:#001}
.exp-actions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;padding:10px}
.btn{border:0;border-radius:10px;padding:10px 14px;cursor:pointer;color:#fff;background:#184a67}
.btn.secondary{background:#254b5a}
.cta-fab{position:fixed;right:18px;bottom:18px;z-index:8890;border:0;border-radius:999px;padding:14px 18px;font-size:16px;background:#2aa2ff;color:#072233;box-shadow:0 6px 24px rgba(0,0,0,.35);display:none}
.cta-fab.show{display:inline-flex;align-items:center;gap:8px}
.cta-fab.pulse{transform:scale(1.06);transition:.15s}

/* æ‹ç…§è¦–çª— */
.pb-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;z-index:9999}
.pb-wrap{position:absolute;inset:0;margin:auto;background:#0b2230;color:#fff;max-width:min(92vw,880px);border-radius:14px;box-shadow:0 10px 50px rgba(0,0,0,.35);overflow:hidden}
.pb-head{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:#0f2e40}
.pb-head b{font-size:18px}
.pb-close{background:#173d54;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
.pb-body{display:grid;grid-template-columns:1fr 300px;gap:12px;padding:12px}
.pb-left{display:grid;gap:8px;align-items:center;justify-items:center}
.pb-cam{background:#000;display:grid;place-items:center;width:100%;aspect-ratio:3/4;border-radius:10px;overflow:hidden}
.pb-cam video,.pb-cam img{width:100%;height:100%;object-fit:cover}
.pb-canvas{display:none}
.pb-right{display:grid;gap:10px}
.pb-right .row{display:flex;gap:8px;flex-wrap:wrap}
.pb-right button,.pb-right label{border:0;background:#184a67;color:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
.pb-right button[disabled]{opacity:.6;cursor:not-allowed}
.pb-right input[type="file"]{display:none}
.pb-txt{background:#0f2e40;border-radius:10px;padding:10px;font-size:14px;line-height:1.45}
.pb-qr{display:none;background:#0f2e40;border-radius:10px;padding:10px;text-align:center}
.pb-qr img{max-width:100%;height:auto;display:block;margin:8px auto}
@media (max-width:900px){.pb-body{grid-template-columns:1fr}}

/* æ‰‹æ©Ÿä¸Šä¿è­‰çœ‹å¾—åˆ°æ¸…é™¤éµèˆ‡çµ±è¨ˆåˆ— */
@media (max-width: 520px){
  #clearCurrent{ order: 98; width: 100%; }
  .stats{ order: 99; width: 100%; justify-content:flex-start; }
}
</style>
</head>
<body>
<div class="wrap">
  <h1>æµ·é¾œè¯å®¹é“</h1>

  <div class="subtitle">
    é¸æ“‡æµ·é¾œç¨®é¡ï¼š
    <select id="turtleSelect" aria-label="é¸æ“‡æµ·é¾œç¨®é¡">
      <option value="leatherback">é©é¾œ</option>
      <option value="green">ç¶ è µé¾œ</option>
      <option value="olive">æ¬–è µé¾œ</option>
      <option value="hawksbill">ç³ç‘</option>
      <option value="loggerhead">èµ¤è µé¾œ</option>
    </select>
  </div>

  <div class="subtitle">é»æ“Šæˆ–è§¸æ§ç›¸é„°ç©ºæ ¼çš„æ‹¼åœ–å¡Šï¼Œä½¿åœ–ç‰‡é‚„åŸã€‚</div>

  <div class="toolbar">
    <div class="sizes" role="group" aria-label="é¸æ“‡é›£åº¦">
      <button data-n="2" class="sizeBtn">2Ã—2 ç°¡å–®</button>
      <button data-n="3" class="sizeBtn active">3Ã—3 ä¸€èˆ¬</button>
      <button data-n="4" class="sizeBtn">4Ã—4 æŒ‘æˆ°</button>
    </div>
    <button id="shuffle">é‡æ–°æ´—ç‰Œ</button>
    <button id="reset">é‚„åŸ</button>
    <button id="toggleVibrate">éœ‡å‹•ï¼šé–‹</button>
    <button id="clearCurrent" onclick="clearCurrentRecord()">æ¸…é™¤ç•¶å‰ç´€éŒ„</button>

    <div class="stats">
      <span>æ­¥æ•¸ï¼š<strong id="moves">0</strong></span>
      <span>æ™‚é–“ï¼š<strong id="time">00:00.0</strong></span>
      <span>|</span>
      <span>æ­·å²æœ€ä½³æ­¥æ•¸ï¼š<strong id="bestMoves">â€”</strong></span>
      <span>æ­·å²æœ€ä½³æ™‚é–“ï¼š<strong id="bestTime">â€”</strong></span>
      <span id="recordFlag" class="small"></span>
    </div>
  </div>

  <div class="board" id="board" aria-label="Sliding puzzle board" aria-live="polite">
    <div class="gridlines" id="gridlines" aria-hidden="true"></div>
    <div class="win" id="win"><div class="card"><strong>å®Œæˆï¼</strong></div></div>
  </div>
</div>

<!-- ç ´é—œéŸ³æ•ˆ -->
<audio id="winSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<!-- è§£èªªè¦–çª— -->
<div id="exp" class="exp-backdrop" role="dialog" aria-modal="true" aria-label="æµ·é¾œè§£èªª">
  <div class="exp-wrap">
    <div class="exp-head">
      <b>æµ·é¾œè§£èªª</b>
      <button class="btn secondary" onclick="closeExplanation()">é—œé–‰</button>
    </div>
    <div class="exp-body">
      <img id="expImg" alt="æµ·é¾œè§£èªªåœ–">
    </div>
    <div class="exp-actions">
      <button class="btn secondary" onclick="replayLevel()">å†ç©ä¸€æ¬¡</button>
      <button class="btn" onclick="openPhotoBooth()">æ‹ç…§ç•™å¿µ</button>
    </div>
  </div>
</div>
<button id="photoFab" class="cta-fab" onclick="openPhotoBooth()" aria-label="æ‹ç…§ç•™å¿µ">ğŸ“· æ‹ç…§ç•™å¿µ</button>

<!-- æ‹ç…§è¦–çª— -->
<div class="pb-backdrop" id="pb">
  <div class="pb-wrap">
    <div class="pb-head">
      <b>æµ·é¾œè¯å®¹é“ï½œæ‹ç…§ç•™å¿µ</b>
      <button class="pb-close" onclick="closePhotoBooth()">é—œé–‰</button>
    </div>
    <div class="pb-body">
      <div class="pb-left">
        <div class="pb-cam">
          <video id="pbVideo" playsinline autoplay muted></video>
          <img id="pbUploadPreview" alt="" style="display:none"/>
        </div>
        <canvas id="pbCanvas" class="pb-canvas" width="900" height="1200"></canvas>
      </div>
      <div class="pb-right">
        <div class="row">
          <button id="pbUseCamBtn">é–‹å•Ÿç›¸æ©Ÿ</button>
          <label for="pbFile">å¾ç›¸ç°¿é¸ç…§ç‰‡</label>
          <input id="pbFile" type="file" accept="image/*" />
        </div>
        <div class="row">
          <button data-tpl="patrol" class="tplBtn">å¥—ç”¨ï¼šå·¡æŸ¥å“¡</button>
          <button data-tpl="coast" class="tplBtn">å¥—ç”¨ï¼šæµ·å·¡</button>
        </div>
        <div class="row">
          <button id="pbSnapBtn" disabled>æ‹ç…§/åˆæˆ</button>
          <a id="pbDl" download="æµ·é¾œè¯å®¹é“_ç•™å¿µ.jpg"><button id="pbDlBtn" disabled>ä¸‹è¼‰åœ–ç‰‡</button></a>
        </div>
        <div class="row">
          <button id="pbShareBtn" disabled>åˆ†äº«ï¼ˆè¡Œå‹•è£ç½®ï¼‰</button>
          <button id="pbQrBtn" disabled>ç”¢ç”Ÿ QR</button>
        </div>
        <div id="pbQrBox" class="pb-qr">
          <div>æƒæä¸‹è¼‰ï¼ˆè‹¥æƒæå™¨ä¸æ”¯æ´ data: é€£çµï¼Œè«‹æ”¹ç”¨ä¸‹è¼‰/åˆ†äº«ï¼‰</div>
          <img id="pbQrImg" alt="QR Code">
          <div id="pbQrHint" style="font-size:12px;opacity:.8"></div>
        </div>
        <div class="pb-txt">æµç¨‹ï¼šé–‹ç›¸æ©Ÿ/é¸ç…§ç‰‡ â†’ é¸æ¨¡æ¿ â†’ æ‹ç…§åˆæˆ â†’ ä¸‹è¼‰ / åˆ†äº« / ç”¢ç”Ÿ QRã€‚<br>iOS Safari ä¸æ”¯æ´éœ‡å‹•ï¼›QR å®¹é‡æœ‰é™ã€‚</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =====================
   ç‰©ç¨®è³‡æ–™ï¼ˆä¸»åœ–åå³å¯ï¼›infoImg æœƒè‡ªå‹•ä¿åº•ç‚ºä¸»åœ–ï¼‰
===================== */
const turtleData = {
  leatherback: { img: 'leatherback', title: 'é©é¾œï¼ˆDermochelys coriaceaï¼‰', desc: 'ä¸–ç•Œä¸Šæœ€å¤§çš„æµ·é¾œï¼Œé«”é•·å¸¸è¦‹ 1.5â€“2.0 å…¬å°ºä»¥ä¸Šã€é«”é‡å¯é€¾ 500â€“900 å…¬æ–¤ã€‚èƒŒç”²ç„¡ç¡¬é±—ï¼Œç‚ºé©è³ªå¤–çš®è¦†è“‹éª¨æ¿è€Œå¾—åã€‚å°ç£æ›¾æ–¼æ±éƒ¨å¤–æµ·ã€æ¾æ¹–ã€æ±æ²™æµ·åŸŸæœ‰ç´€éŒ„ã€‚', infoImg: '' },
  green:       { img: 'green',       title: 'ç¶ è µé¾œï¼ˆChelonia mydasï¼‰', desc: 'æˆé¾œä»¥æµ·è‰ã€æµ·è—»ç‚ºä¸»é£Ÿï¼Œé«”è‰²åç¶ ã€‚å°ç£å¸¸è¦‹æ–¼è˜­å¶¼ã€ç¶ å³¶èˆ‡å¢¾ä¸æµ·åŸŸï¼Œäº¦æœ‰ä¸Šå²¸ç”¢åµç´€éŒ„é»ã€‚', infoImg: '' },
  olive:       { img: 'olive',       title: 'æ¬–è µé¾œï¼ˆLepidochelys olivaceaï¼‰', desc: 'é«”å‹è¼ƒå°ï¼ŒèƒŒç”²æ©„æ¬–ç¶ è‰²ï¼Œå¸¸è¦‹æ–¼ç†±å¸¶åŠäºç†±å¸¶æ²¿æµ·ã€‚å°ç£æµ·åŸŸå¶æœ‰å‡ºç¾ç´€éŒ„ã€‚', infoImg: '' },
  hawksbill:   { img: 'hawksbill',   title: 'ç³ç‘ï¼ˆEretmochelys imbricataï¼‰', desc: 'èƒŒç”²é±—ç‰‡é‡ç–Šã€é¾œç”²é‚Šç·£å…·é‹¸é½’ï¼Œå¸¸æ´»å‹•æ–¼çŠç‘šç¤ã€‚å°ç£å—éƒ¨åŠé›¢å³¶çŠç‘šç¤å€è¼ƒæ˜“è¦‹ã€‚', infoImg: '' },
  loggerhead:  { img: 'loggerhead',  title: 'èµ¤è µé¾œï¼ˆCaretta carettaï¼‰', desc: 'é ­éƒ¨å¯¬å¤§ã€èƒŒç”²ç´…è¤è‰²ï¼Œåå¥½ç¡¬æ®¼ç„¡è„Šæ¤å‹•ç‰©ã€‚å°ç£å‘¨é‚Šæµ·åŸŸæœ‰æ´„æ¸¸èˆ‡å¶è¦‹ç´€éŒ„ã€‚', infoImg: '' }
};

/* =====================
   åœ–ç‰‡è‡ªå‹•å°‹è·¯ï¼ˆè³‡æ–™å¤¾ï¼‹å‰¯æª”åè‡ªå‹•æ¢æ¸¬ï¼‰
===================== */
const CANDIDATE_DIRS = ['./', './assets/', './img/'];
const CANDIDATE_EXTS = ['.jpg', '.png', '.jpeg', '.webp'];

function probeImage(basenameOrPath){
  const list = [];
  if (/\.(jpg|jpeg|png|webp)$/i.test(basenameOrPath)) {
    list.push(basenameOrPath);
    const base = basenameOrPath.replace(/\.(jpg|jpeg|png|webp)$/i,'');
    for (const ext of CANDIDATE_EXTS) list.push(base + ext);
  } else {
    for (const dir of CANDIDATE_DIRS)
      for (const ext of CANDIDATE_EXTS) list.push(dir + basenameOrPath + ext);
  }
  return new Promise(resolve=>{
    let i=0;
    (function tryNext(){
      if (i>=list.length) return resolve('');
      const src=list[i++], test=new Image();
      test.onload = ()=>resolve(src);
      test.onerror= tryNext;
      test.src = src;
    })();
  });
}

async function resolveAllTurtleImages(){
  const keys = Object.keys(turtleData||{});
  for (const k of keys){
    const d = turtleData[k];
    d._imgResolved  = await probeImage(d.img);
    d._infoResolved = d.infoImg ? await probeImage(d.infoImg) : '';
    if (!d._infoResolved) d._infoResolved = d._imgResolved; // è§£èªªä¿åº•ç‚ºä¸»åœ–
  }
  // åˆå§‹åŒ–æ™‚ä»¥è§£æå¾Œåœ–æª”è¨­å®šç‰ˆé¢æ¯”ä¾‹
  setBoardAspect(turtleSrc(currentTurtle));
}
function turtleSrc(key){ return (turtleData[key] && (turtleData[key]._imgResolved || turtleData[key].img)) || ''; }
function turtleInfoSrc(key){ 
  return (turtleData[key] && (turtleData[key]._infoResolved || turtleData[key]._imgResolved || turtleData[key].img)) || '';
}

/* =====================
   éŠæˆ²ä¸»ç¨‹å¼
===================== */
let N = 3, total = N*N, emptyGoal = total-1;
let currentTurtle = 'leatherback';
let tiles = [];
let moves = 0, timer = null, startTime = null, elapsedMs = 0;

// è¨˜éŒ„æ˜¯å¦ç‚ºã€Œåˆæ³•æ–°å±€ã€
const run = { startedFromShuffle:false, usedRestore:false, seed:0 };

// DOM
const board = document.getElementById('board');
const gridlines = document.getElementById('gridlines');
const movesEl = document.getElementById('moves');
const timeEl = document.getElementById('time');
const winEl = document.getElementById('win');
const selectEl = document.getElementById('turtleSelect');
const winSound = document.getElementById('winSound');
const toggleBtn = document.getElementById('toggleVibrate');
const flagEl = document.getElementById('recordFlag');

// éœ‡å‹•
let vibrateOn = localStorage.getItem('turtle_vibrate') !== 'off';

/* ç´€éŒ„ï¼ˆä¾ç‰©ç¨®+å°ºå¯¸ï¼‰ */
const LS_KEY = 'turtle_puzzle_records_v3';
function loadRecords(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)) || {}; } catch(e){ return {}; } }
function saveRecords(r){ localStorage.setItem(LS_KEY, JSON.stringify(r)); }
function keyOf(t,n){ return `${t}__${n}`; }
let records = loadRecords();

function updateBestUI(){
  const r = records[keyOf(currentTurtle, N)] || {};
  document.getElementById('bestMoves').textContent = (r.bestMoves!=null) ? `${r.bestMoves} æ­¥` : 'â€”';
  document.getElementById('bestTime').textContent = (r.bestTimeMs!=null) ? formatMs(r.bestTimeMs) : 'â€”';
}

/* å·¥å…· */
const p2xy = p => ({ x:p%N, y:Math.floor(p/N) });
const xy2p = (x,y) => y*N + x;

function formatMs(ms){
  const m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), ds = Math.floor((ms%1000)/100);
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ds}`;
}
function setBoardAspect(src){
  if(!src) return;
  const img = new Image();
  img.onload = ()=>{ board.style.aspectRatio = `${img.naturalWidth} / ${img.naturalHeight}`; draw(); };
  img.src = src;
}

/* Haptics */
function haptic(kind){
  if(!vibrateOn || !('vibrate' in navigator)) return;
  if(kind==='move') navigator.vibrate(12);
  else if(kind==='shuffle') navigator.vibrate([8,30,8]);
  else if(kind==='win') navigator.vibrate([25,30,25,30,40]);
}
function tryHapticWin(){
  try{
    if ('vibrate' in navigator) navigator.vibrate([30,50,30]);
    else {
      const fab = document.getElementById('photoFab');
      if (fab){ fab.classList.add('pulse'); setTimeout(()=>fab.classList.remove('pulse'), 800); }
    }
  }catch(e){}
}

/* è¨ˆæ™‚å™¨ */
function startTimer(){
  stopTimer(); startTime = Date.now(); elapsedMs = 0;
  timeEl.textContent = '00:00.0';
  timer = setInterval(()=>{ elapsedMs = Date.now() - startTime; timeEl.textContent = formatMs(elapsedMs); }, 100);
}
function stopTimer(){ if(timer){ clearInterval(timer); timer=null; } }

/* æ´—ç‰Œï¼ˆä¸€å®šå¯è§£ï¼‰ */
function shuffle(){
  tiles = Array.from({length: total}, (_,i)=>i);
  const steps = 80 * N * N;
  for(let i=0;i<steps;i++){
    const e = tiles.indexOf(emptyGoal);
    const {x,y} = p2xy(e);
    const ops = [];
    if(x>0) ops.push(xy2p(x-1,y));
    if(x<N-1) ops.push(xy2p(x+1,y));
    if(y>0) ops.push(xy2p(x,y-1));
    if(y<N-1) ops.push(xy2p(x,y+1));
    const s = ops[Math.floor(Math.random()*ops.length)];
    [tiles[e], tiles[s]] = [tiles[s], tiles[e]];
  }
  moves = 0; movesEl.textContent = moves;
  startTimer(); winEl.classList.remove('show');
  draw(); haptic('shuffle');

  run.startedFromShuffle = true;
  run.usedRestore = false;
  run.seed = Date.now();
  if (flagEl) flagEl.textContent = 'ï¼ˆæœ¬å±€å¯è¨ˆå…¥ç´€éŒ„ï¼‰';
}

/* æ£‹ç›¤æ ¼ç·š */
function updateGridlines(){
  if(N===2){
    gridlines.style.background =
      'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat';
  }else if(N===3){
    gridlines.style.background =
      'linear-gradient(#ffffff26,#ffffff26) 0 33.333%/100% 1px no-repeat,'+
      'linear-gradient(#ffffff26,#ffffff26) 0 66.666%/100% 1px no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 33.333% 0/1px 100% no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 66.666% 0/1px 100% no-repeat';
  }else{
    gridlines.style.background =
      'linear-gradient(#ffffff26,#ffffff26) 0 25%/100% 1px no-repeat,'+
      'linear-gradient(#ffffff26,#ffffff26) 0 50%/100% 1px no-repeat,'+
      'linear-gradient(#ffffff26,#ffffff26) 0 75%/100% 1px no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 25% 0/1px 100% no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 50% 0/1px 100% no-repeat,'+
      'linear-gradient(90deg,#ffffff26,#ffffff26) 75% 0/1px 100% no-repeat';
  }
}

/* ç¹ªè£½ */
function draw(){
  board.querySelectorAll('.tile').forEach(t=>t.remove());
  const bw = board.clientWidth, bh = board.clientHeight;
  const cellX = bw/N, cellY = bh/N;
  const bgSrc = turtleSrc(currentTurtle);

  tiles.forEach((val, idx)=>{
    const {x,y} = p2xy(idx);
    const tile = document.createElement('div');
    tile.className = 'tile' + (val===emptyGoal ? ' empty':'');
    tile.style.width = `${cellX - 4}px`;
    tile.style.height = `${cellY - 4}px`;
    tile.style.transform = `translate(${x*cellX + 2}px, ${y*cellY + 2}px)`;
    tile.style.backgroundImage = `url('${bgSrc}')`;
    tile.style.backgroundSize = `${N*100}% ${N*100}%`;
    const bx = (100/(N-1)) * p2xy(val).x;
    const by = (100/(N-1)) * p2xy(val).y;
    tile.style.backgroundPosition = `${bx}% ${by}%`;

    tile.addEventListener('click', ()=>move(idx));
    tile.addEventListener('touchstart', e=>{ e.preventDefault(); move(idx); }, {passive:false});
    board.appendChild(tile);
  });
  updateGridlines();
}

/* ç§»å‹•èˆ‡å‹åˆ© */
function move(idx){
  const e = tiles.indexOf(emptyGoal);
  const a = p2xy(idx), b = p2xy(e);
  if(Math.abs(a.x-b.x)+Math.abs(a.y-b.y)===1){
    [tiles[e], tiles[idx]] = [tiles[idx], tiles[e]];
    moves++; movesEl.textContent = moves;
    draw(); haptic('move');

    if(tiles.every((v,i)=>v===i)){
      stopTimer();
      winSound.currentTime = 0; winSound.play().catch(()=>{});
      haptic('win');
      tryHapticWin(); // å†ä¸€æ¬¡è§¸è¦ºï¼ˆAndroidæœ‰æ„Ÿï¼›iOSç„¡ï¼‰

      showWinCardAndRecord();

      // è§£èªªåœ–ä¿åº•ï¼šæ²’æœ‰ info å°±ç”¨ä¸»åœ–
      onGameSolved(turtleInfoSrc(currentTurtle));
    }
  }
}

function showWinCardAndRecord(){
  const eligible = run.startedFromShuffle && !run.usedRestore;
  let broke = false;

  if (eligible) {
    const k = `${currentTurtle}__${N}`;
    const r = records[k] || {};
    if(r.bestMoves==null || moves < r.bestMoves){ r.bestMoves = moves; broke = true; }
    if(r.bestTimeMs==null || elapsedMs < r.bestTimeMs){ r.bestTimeMs = elapsedMs; broke = true; }
    records[k] = r; saveRecords(records); updateBestUI();
  }

  const data = turtleData[currentTurtle];
  const extra = eligible
    ? (broke ? '<br><strong>ğŸ‰ åˆ·æ–°æ­·å²æœ€ä½³ï¼</strong>' : '')
    : '<br><em style="color:#888">ï¼ˆæ­¤å±€å«é‚„åŸï¼éæ–°å±€ï¼Œä¸åˆ—å…¥æœ€ä½³ç´€éŒ„ï¼‰</em>';

  winEl.innerHTML = `
  <div class="card" role="dialog" aria-label="å®Œæˆè§£èªªå¡">
    <h2>${data.title}</h2>
    <p style="text-align:left">${data.desc}</p>
    <p class="small">æœ¬å±€æ­¥æ•¸ï¼š${movesEl.textContent}ï½œç”¨æ™‚ï¼š${timeEl.textContent}${extra}</p>
    <button onclick="document.getElementById('win').classList.remove('show')">é—œé–‰</button>
  </div>`;
  winEl.classList.add('show');
}

/* åªæ¸…é™¤ã€Œç•¶å‰é—œå¡ã€ç´€éŒ„ */
function clearCurrentRecord(){
  const key = `${currentTurtle}__${N}`;
  const store = JSON.parse(localStorage.getItem(LS_KEY) || '{}');
  if (store[key]) {
    delete store[key];
    localStorage.setItem(LS_KEY, JSON.stringify(store));
    document.getElementById('bestMoves').textContent = 'â€”';
    document.getElementById('bestTime').textContent = 'â€”';
    alert(`å·²æ¸…é™¤ã€Œ${currentTurtle}ã€${N}Ã—${N} çš„æœ€ä½³ç´€éŒ„`);
  } else {
    alert('ç›®å‰é€™ä¸€é—œæ²’æœ‰å·²å„²å­˜çš„æœ€ä½³ç´€éŒ„');
  }
}
window.clearCurrentRecord = clearCurrentRecord;

/* å°ºå¯¸èˆ‡äº‹ä»¶ */
function changeSize(n){
  N = n; total = N*N; emptyGoal = total - 1;
  document.querySelectorAll('.sizeBtn').forEach(btn=>{
    btn.classList.toggle('active', Number(btn.dataset.n)===N);
  });
  setBoardAspect(turtleSrc(currentTurtle));
  shuffle();
  updateBestUI();
}

document.getElementById('shuffle').addEventListener('click', shuffle);

document.getElementById('reset').addEventListener('click', ()=>{
  tiles = Array.from({length: total}, (_,i)=>i);
  moves = 0; movesEl.textContent = moves;
  stopTimer(); elapsedMs = 0; timeEl.textContent='00:00.0';
  draw();

  run.startedFromShuffle = false;
  run.usedRestore = true;
  if (flagEl) flagEl.textContent = 'ï¼ˆæœ¬å±€ä¸è¨ˆå…¥ç´€éŒ„ï¼‰';
});

document.querySelectorAll('.sizeBtn').forEach(btn=>{
  btn.addEventListener('click', ()=> changeSize(Number(btn.dataset.n)));
});

selectEl.addEventListener('change', e=>{
  currentTurtle = e.target.value;
  setBoardAspect(turtleSrc(currentTurtle));
  shuffle();
  updateBestUI();
});

// éœ‡å‹•é–‹é—œ
toggleBtn.textContent = vibrateOn ? "éœ‡å‹•ï¼šé–‹" : "éœ‡å‹•ï¼šé—œ";
toggleBtn.addEventListener('click', ()=>{
  vibrateOn = !vibrateOn;
  localStorage.setItem('turtle_vibrate', vibrateOn ? 'on' : 'off');
  toggleBtn.textContent = vibrateOn ? "éœ‡å‹•ï¼šé–‹" : "éœ‡å‹•ï¼šé—œ";
});

window.addEventListener('resize', draw);

/* åˆå§‹åŒ– */
window.addEventListener('DOMContentLoaded', ()=>{
  resolveAllTurtleImages().then(()=>{
    updateBestUI();
    shuffle();
  });
});
</script>

<script>
/* =====================
   éé—œâ†’è§£èªªâ†’æ‹ç…§æµç¨‹
===================== */
function onGameSolved(explainImageUrl){
  tryHapticWin(); // Android éœ‡å‹•ï¼›iOS Safari æœ¬ä¾†ä¸æ”¯æ´

  const img = document.getElementById('expImg');
  img.removeAttribute('src');
  img.dataset.triedFallback = '0';
  img.onerror = ()=>{
    const fallback = turtleSrc(window.currentTurtle);
    if (img.dataset.triedFallback !== '1' && fallback){
      img.dataset.triedFallback = '1';
      img.src = fallback; // ç¬¬ä¸€æ¬¡å¤±æ•— â†’ ä¸»åœ–
    } else {
      img.alt = 'ï¼ˆæœ¬ç‰©ç¨®æš«ç„¡è§£èªªåœ–ï¼‰';
      img.style.minHeight = '200px';
    }
  };
  img.src = explainImageUrl || turtleSrc(window.currentTurtle);

  const exp = document.getElementById('exp');
  exp.style.display = 'block';
  document.body.style.overflow = 'hidden';

  setTimeout(()=> document.getElementById('photoFab').classList.add('show'), 2000);
}

function closeExplanation(){
  const el = document.getElementById('exp');
  el.style.display = 'none';
  document.body.style.overflow = '';
  document.getElementById('photoFab').classList.remove('show');
}
function replayLevel(){
  closeExplanation();
  shuffle();
}
</script>

<script>
/* =====================
   æ‹ç…§ç•™å¿µï¼ˆ2 æ¨¡æ¿ï¼‹QRï¼‰
===================== */
const FRAMES = {
  patrol: './å·¡æŸ¥å“¡.png',
  coast:  './æµ·å·¡.png'
};

const pb = {
  video:null, canvas:null, ctx:null, stream:null,
  usingUpload:false, tpl:'patrol',
  W:900, H:1200, // 3:4
  frameCanvas:null, _smallJpg:null
};

function openPhotoBooth(){
  const el = document.getElementById('pb');
  el.style.display = 'block';
  document.body.style.overflow = 'hidden';
}
function closePhotoBooth(){
  stopCam();
  const el = document.getElementById('pb');
  el.style.display = 'none';
  document.body.style.overflow = '';
}

window.addEventListener('DOMContentLoaded', ()=>{
  pb.video = document.getElementById('pbVideo');
  pb.canvas = document.getElementById('pbCanvas');
  pb.ctx = pb.canvas.getContext('2d', { willReadFrequently:true });

  document.getElementById('pbUseCamBtn').addEventListener('click', useCamera);
  document.getElementById('pbFile').addEventListener('change', handleFile);
  document.getElementById('pbSnapBtn').addEventListener('click', doSnapshot);
  document.getElementById('pbQrBtn').addEventListener('click', makeQR);
  document.getElementById('pbShareBtn').addEventListener('click', webShare);

  document.querySelectorAll('.tplBtn').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      document.querySelectorAll('.tplBtn').forEach(b=>b.style.outline='');
      e.currentTarget.style.outline = '3px solid #39b5ff';
      pb.tpl = e.currentTarget.dataset.tpl;
      pb.frameCanvas = await loadFrameCanvas(pb.tpl);
    });
  });

  loadFrameCanvas(pb.tpl).then(fc => pb.frameCanvas = fc);
});

/* ç›¸æ©Ÿ / ç›¸ç°¿ */
async function useCamera(){
  try{
    stopCam(); pb.usingUpload=false; hideUploadPreview();
    pb.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'user', aspectRatio:3/4 }});
    pb.video.srcObject = pb.stream;
    document.getElementById('pbSnapBtn').disabled = false;
  }catch(err){
    alert('ç›¸æ©Ÿç„¡æ³•ä½¿ç”¨ï¼Œè«‹æ”¹ç”¨ã€Œå¾ç›¸ç°¿é¸ç…§ç‰‡ã€ã€‚\n' + err.message);
  }
}
function stopCam(){ if (pb.stream){ pb.stream.getTracks().forEach(t=>t.stop()); pb.stream=null; } }
function handleFile(e){
  const file = e.target.files?.[0]; if(!file) return;
  stopCam(); pb.usingUpload = true;
  const url = URL.createObjectURL(file);
  const img = document.getElementById('pbUploadPreview');
  img.onload = ()=> URL.revokeObjectURL(url);
  img.src = url; img.style.display = 'block';
  pb.video.style.display = 'none';
  document.getElementById('pbSnapBtn').disabled = false;
}
function hideUploadPreview(){ const img = document.getElementById('pbUploadPreview'); img.style.display='none'; pb.video.style.display='block'; }

/* æ¨¡æ¿ï¼šå°‡è¿‘ç™½åƒç´ è®Šé€æ˜ï¼ˆæŒ–è‡‰æ´ï¼‰ */
async function loadFrameCanvas(kind){
  const src = FRAMES[kind];
  const img = new Image(); img.crossOrigin='anonymous'; img.src = src;
  await img.decode().catch(()=>{});
  const off = document.createElement('canvas'); off.width = pb.W; off.height = pb.H;
  const octx = off.getContext('2d');
  octx.drawImage(img, 0, 0, off.width, off.height);
  try{
    const data = octx.getImageData(0,0,off.width,off.height);
    const px = data.data;
    for(let i=0;i<px.length;i+=4){
      const r=px[i], g=px[i+1], b=px[i+2];
      if(r>245 && g>245 && b>245) px[i+3]=0; // ç™½â†’é€æ˜
    }
    octx.putImageData(data,0,0);
  }catch(e){}
  return off;
}

/* æ‹ç…§åˆæˆ */
function doSnapshot(){
  const ctx = pb.ctx, W=pb.W, H=pb.H;
  ctx.clearRect(0,0,W,H);

  if(pb.usingUpload){
    const img = document.getElementById('pbUploadPreview'); drawCover(ctx,img,W,H);
  }else{
    const v = pb.video; drawCover(ctx,v,W,H);
  }
  if(pb.frameCanvas) ctx.drawImage(pb.frameCanvas, 0, 0, W, H);

  const dataURLpng = pb.canvas.toDataURL('image/png');
  const smallJpg = canvasToScaledJpeg(pb.canvas, 720, 960, 0.7);

  const a = document.getElementById('pbDl'); a.href = dataURLpng;
  document.getElementById('pbDlBtn').disabled = false;
  document.getElementById('pbShareBtn').disabled = false;
  document.getElementById('pbQrBtn').disabled = false;
  document.getElementById('pbQrBox').style.display = 'none';
  pb.canvas.style.display = 'block';
  pb._smallJpg = smallJpg;
}

/* å°å·¥å…· */
function drawCover(ctx, src, W, H){
  const iw = src.videoWidth || src.naturalWidth;
  const ih = src.videoHeight || src.naturalHeight;
  if(!iw || !ih){ alert('ä¾†æºå°šæœªå°±ç·’ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚'); return; }
  const s = Math.max(W/iw, H/ih);
  const dw = iw*s, dh = ih*s;
  const dx = (W-dw)/2, dy = (H-dh)/2;
  ctx.drawImage(src, dx, dy, dw, dh);
}
function canvasToScaledJpeg(srcCanvas, w, h, q){
  const c = document.createElement('canvas'); c.width=w; c.height=h;
  c.getContext('2d').drawImage(srcCanvas,0,0,w,h);
  return c.toDataURL('image/jpeg', q);
}

/* ç”¢ç”Ÿ QRï¼ˆä»¥ data:URLï¼›éå¤§æœƒæé†’ï¼‰ */
function makeQR(){
  const box = document.getElementById('pbQrBox');
  const img = document.getElementById('pbQrImg');
  const hint = document.getElementById('pbQrHint');
  const dataUrl = pb._smallJpg || pb.canvas.toDataURL('image/jpeg', 0.7);
  if (dataUrl.length > 3800){
    box.style.display='block';
    img.src=''; hint.textContent='åœ–ç‰‡éå¤§ï¼ŒQR ç„¡æ³•å®¹ç´ã€‚è«‹æ”¹ç”¨ã€Œä¸‹è¼‰ã€æˆ–ã€Œåˆ†äº«ã€ã€‚';
    return;
  }
  const api='https://api.qrserver.com/v1/create-qr-code/?size=320x320&margin=1&data=';
  img.src = api + encodeURIComponent(dataUrl);
  hint.textContent='è‹¥æƒæå™¨ç„¡æ³•é–‹å•Ÿï¼Œè«‹æ”¹ç”¨ä¸‹è¼‰/åˆ†äº«ã€‚';
  box.style.display='block';
}

/* åˆ†äº«ï¼ˆè¡Œå‹•è£ç½®ï¼‰ */
async function webShare(){
  try{
    if (navigator.canShare){
      const blob = await (await fetch(pb.canvas.toDataURL('image/png'))).blob();
      const file = new File([blob], 'æµ·é¾œè¯å®¹é“_ç•™å¿µ.png', {type:'image/png'});
      await navigator.share({ files:[file], title:'æµ·é¾œè¯å®¹é“', text:'æˆ‘çš„ç•™å¿µç…§' });
    }else{
      alert('æ­¤è£ç½®/ç€è¦½å™¨ä¸æ”¯æ´ Web Shareï¼Œè«‹æ”¹ç”¨ã€Œä¸‹è¼‰ã€æˆ– QRã€‚');
    }
  }catch(e){}
}
</script>
</body>
</html>
